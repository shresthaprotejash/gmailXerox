<!DOCTYPE html>
<html>
<head>

    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
    <title>GmailAuth</title>

</head>

<body ng-app="myApp" ng-controller="ctrl">

    <img ng-click="login()" src="https://res.cloudinary.com/practicaldev/image/fetch/s--YVSXRIP0--/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://thepracticaldev.s3.amazonaws.com/i/c74ljgt1t4o1ko28ycm8.png">

<script>

    var app = angular.module("myApp", []);
    
    app.controller("ctrl",function($scope,$http, $window){
        var url;
        $http.get("url").then(function(response){
            //alert(response.data);
            url=response.data;
        });    

    var win;
    $scope.login = function(){
        win = $window.open(url,"hello","width=500px,height=700px");
    }

    window.onmessage = function(e){
        win.close();
        var urlWithCode = e.data;
        console.log(urlWithCode); 

        var idx = urlWithCode.lastIndexOf("code=");
        var code = urlWithCode.substring(idx + 5,urlWithCode.lastIndexOf("&scope=")).replace("#","");

        console.log(code);

        $http.get("tokens?code="+code).then(function(response){
            if(response.data){
                console.log(response.data);
                $window.location.href = '/search';
            }
        })
    }

    });
   
 </script>
</body>
</html>